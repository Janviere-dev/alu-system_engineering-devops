#!/usr/bin/env bash
# Configures Nginx to send a custom X-Served-By header using the server's hostname

set -e

# Update package lists
apt-get update -y

# Install Nginx if it's not already installed
apt-get install -y nginx

# Get the server hostname
HOSTNAME=$(hostname)

# Modify Nginx default site config to include the custom header
CONFIG="/etc/nginx/sites-available/default"

# Only inject header if it's not already present
if ! grep -q "add_header X-Served-By" "$CONFIG"; then
    # Use sed to add header line inside the server block
    sed -i "/server_name _;/a \\tadd_header X-Served-By \"$HOSTNAME\";" "$CONFIG"
fi

# Restart Nginx to apply changes
systemctl restart nginx

